name: Tests

on:
  push:
    branches: [main, 0.4.x]
  pull_request:
    branches: [main, 0.4.x]

defaults:
  run:
    shell: bash -l {0}

env:
  CACHE_EPOCH: 1
  BINDER_ENV: .binder/environment.yml

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Cache JS
        uses: actions/cache@v3
        with:
          path: node_modules
          key: |
            ${{ env.CACHE_EPOCH }}-node-modules-${{ runner.os }}-${{ hashFiles('yarn.lock') }}

      - name: Setup conda
        uses: conda-incubator/setup-miniconda@v2
        with:
          environment-file: ${{ env.BINDER_ENV }}
          miniforge-variant: Mambaforge
          use-mamba: true

      - name: Install JS deps
        run: jlpm --prefer-offline --ignore-optional

      - name: Build JS
        run: jlpm build:prod

      - name: Build Python packages
        run: pyproject-build --sdist --wheel --no-isolation

      - name: Check built packages
        run: twine check dist/*

      - name: Build NPM package
        run: cd dist && npm pack --ignore-scripts ..

      - name: Hash Distributions
        run: cd dist && sha256sum * | tee SHA256SUMS

      - name: Upload Distributions
        uses: actions/upload-artifact@v3
        with:
          name: jupyterlab_robotmode_dist_${{ github.run_number }}
          path: ./dist

      - name: Install jupyterlab_robotmode
        run: |-
          set -eux
          cd dist && python -m pip install -vv . --no-deps --no-build-isolation --ignore-installed $(ls *.whl)

      - name: Run frontend unit tests
        run: jlpm test

      - name: Lint Python
        run: |-
          set -eux
          black --check setup.py jupyterlab_robotmode
          ruff setup.py jupyterlab_robotmode

  test:
    needs: [build]
    runs-on: ${{ matrix.os }}-latest
    strategy:
      matrix:
        os: [ubuntu, windows, macos]
        python-version: ['3.8', '3.11']
        lab-version: ['3']
        include:
          - python-version: '3.8'
            dist: jupyterlab_robotmode*.tar.gz
          - python-version: '3.11'
            dist: jupyterlab_robotmode*.whl
          - os: windows
            py-cmd: python
            pip-cache: ~\AppData\Local\pip\Cache
          - os: macos
            py-cmd: python3
            pip-cache: ~/Library/Caches/pip
          - os: ubuntu
            py-cmd: python
            pip-cache: ~/.cache/pip

    steps:
      - name: Install Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Download Distributions
        uses: actions/download-artifact@v3
        with:
          name: jupyterlab_robotmode_dist_${{ github.run_number }}
          path: ./dist

      - name: Cache Python Dependencies
        uses: actions/cache@v3
        with:
          path: ${{ matrix.pip-cache }}
          key: |
            ${{ env.CACHE_EPOCH }}-${{ runner.os }}-pip-install-${{ matrix.python-version }}-${{ matrix.lab-version }}
          restore-keys: |
            ${{ env.CACHE_EPOCH }}-${{ runner.os }}-pip-install-${{ matrix.python-version }}-
            ${{ env.CACHE_EPOCH }}-${{ runner.os }}-pip-

      - name: Install Setup Dependencies
        run: |
          set -eux
          ${{ matrix.py-cmd }} -m pip install --upgrade pip wheel build setuptools

      - name: Install Dependencies
        run: |
          set -eux
          ${{ matrix.py-cmd }} -m pip install 'jupyterlab==${{ matrix.lab-version }}.*'

      - name: Install Distribution
        run: |
          set -eux
          cd dist
          ${{ matrix.py-cmd }} -m pip install -v ${{ matrix.dist }} --no-deps --ignore-installed

      - name: Check labextension
        run: |
          set -eux
          ${{ matrix.py-cmd }} -m jupyter labextension list
          ${{ matrix.py-cmd }} -m jupyter labextension list 2>&1 | grep -iE "@marketsquare/jupyterlab_robotmode.*enabled.*ok" -
